# RestFB 2026 Migration Guide

This guide summarizes the user-visible changes introduced on the upcoming 2026 release compared to the previous development state and explains how to adapt your extensions before adopting the 2026.x line.

## 1. DefaultWebRequestor now uses Java 11 HttpClient
RestFB no longer builds requests with `HttpURLConnection`. All traffic is routed through `java.net.http.HttpClient`, which brings HTTP/2 support, transparent keep-alive management, and unified connection pooling.

### 1.1 API updates
- `openConnection(URL)` now returns an `HttpRequest.Builder` instead of an open `HttpURLConnection`.
- `customizeConnection(HttpURLConnection)` has been replaced with `customizeRequest(HttpRequest.Builder builder, Request request, HttpMethod method)`. Override the new hook to add headers, adjust per-request timeouts, or manipulate the builder before sending.
- `fillHeaderAndDebugInfo(HttpURLConnection)`/`fetchResponse(HttpURLConnection)` were consolidated into `fillHeaderAndDebugInfo(HttpResponse<byte[]>)` plus `createResponse(...)`. Subclasses such as `ETagWebRequestor` should override `createResponse` if they need to inspect the raw `HttpResponse`.
- `createHttpClientBuilder()` exposes the shared `HttpClient.Builder`. Override it to tweak proxies, SSL context, executors, or default timeouts.

### 1.2 Migration steps
1. Update custom `DefaultWebRequestor` subclasses to work with `HttpRequest.Builder` instead of `HttpURLConnection`.
2. Replace any direct `getHeaderField(...)` usage with header data supplied via `Response#getHeaders()`.
3. Remove manual `Connection` header managementâ€”`HttpClient` handles keep-alive automatically and rejects that header.
4. Re-run custom tests; if you previously set timeouts/connectors on the connection, move that logic into `customizeRequest` or `createHttpClientBuilder()`.

## 2. BinaryAttachment stream constructors accept Supplier<InputStream>
All previously deprecated `BinaryAttachment.with(..., InputStream ...)` factory methods now require a `Supplier<InputStream>`.

### 2.1 Why the change?
`HttpClient` may need to retry or buffer a request body. Passing a supplier ensures a fresh stream is available each time RestFB writes the body.

### 2.2 Migration steps
- Replace calls such as `BinaryAttachment.with("photo.jpg", inputStream)` with `BinaryAttachment.with("photo.jpg", () -> Files.newInputStream(path))` or any lambda that recreates the stream on demand.
- Update tests/mocks to provide a supplier. If you relied on `InputStream` mocks, return the mock from the supplier or wrap `byte[]` data in a new `ByteArrayInputStream` each time.

## 3. Behavioral notes
- Multipart uploads and Reel uploads share the same streaming infrastructure. Use the provided headers (`offset`, `file_size`, `file_url`) rather than manipulating raw streams.
- Because `HttpClient` enforces header rules, previously ignored headers may now trigger `IllegalArgumentException`. Use `customizeRequest` for optional headers and verify they are allowed by the Java client.
- `HttpClient` negotiates HTTP/2 automatically when Meta endpoints support it; no additional configuration is required.

## 4. Response metadata handling

- Graph calls now offer `fetchObjectWithResult`, `fetchObjectsWithResult`, `publishWithResult` (for every overload) and `deleteObjectWithResult`. These methods wrap the previous return value inside an `ApiResult<T>` that also exposes the parsed `DebugHeaderInfo`, the raw response headers, the HTTP method, full request URL, and the total request duration.
- Connections now expose the same metadata directly via `Connection#getResponseMetadata()`, rendering `fetchConnectionWithResult` and `fetchConnectionPageWithResult` obsolete. Fetch connections as before and pull debug header info, headers, and timing data from the returned `Connection` instance when needed.
- The legacy `setDebugHeaderInfoConsumer`, `setResponseHeaderConsumer`, `getLastDebugHeaderInfo`, and `getLastResponseHeaders` methods have been removed. Use the new `ApiResult` APIs to access metadata on a per-call basis.

## 5. Custom connection instantiation hook

- `FacebookClient` now exposes a default `createConnection(String connectionJson, Class<T> connectionType)` method. Override it (or provide your own `FacebookClient` implementation) if you want to return a specialized `Connection` subtype with extra fields or helper logic. RestFB calls this hook from `DefaultFacebookClient` and from the JSON mapper whenever a connection needs to be materialized, so overriding it centralizes the customization.
- Test doubles/mock clients should either rely on the default implementation (e.g. `thenCallRealMethod()` when using Mockito) or provide their own stub that returns a proper `Connection` instance. Returning `null` will now surface as a mapping failure.


Adopting the 2026 release primarily requires updating custom `WebRequestor` subclasses and migrating any remaining InputStream-based attachments. Once updated, you gain HTTP/2 support, more predictable retries, and cleaner extension hooks by default.
